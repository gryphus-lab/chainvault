version: '3.9'

services:

  chainvault-app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: chainvault-app
    ports:
      - "8085:8085"
    environment:
      SPRING_PROFILES_ACTIVE: local
      # SFTP (from sftp-test)
      target.sftp.host: sftp-test
      target.sftp.port: 22
      target.sftp.username: testuser
      target.sftp.password: testpass123
      target.sftp.remote-directory: /upload
      target.sftp.allow-unknown-keys: "true"
      # Source API (from fake-api)
      source.api.base-url: http://fake-source-api:9090
      source.api.token: dummy
      # PostgreSQL
      spring.datasource.url: jdbc:postgresql://postgres:5432/jobrunr
      spring.datasource.username: jobrunr
      spring.datasource.password: jobrunr
    depends_on:
      - sftp-test
      - fake-source-api
      - postgres
    restart: unless-stopped
  postgres:
    image: postgres:16-alpine
    container_name: postgres-jobrunr
    environment:
      POSTGRES_DB: jobrunr
      POSTGRES_USER: jobrunr
      POSTGRES_PASSWORD: jobrunr
    ports:
      - "5433:5432"           # avoid conflict with local Postgres
    volumes:
        - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jobrunr"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  sftp-test:
    image: atmoz/sftp:latest
    container_name: sftp-test
    ports:
      - "2222:22"             # map to 2222 so it doesn't conflict with host SSH
    environment:
      - SFTP_USERS=testuser:testpass123:::upload
    volumes:
      - sftp-data:/home/testuser/upload
    restart: unless-stopped

  fake-source-api:
    image: node:25-alpine
    container_name: fake-source-api
    working_dir: /app
    command: >
      sh -c "npm install -g json-server &&
        json-server --watch /data/db.json --static /data/static --port 9090 --host 0.0.0.0"
    ports:
      - "9090:9090"
    volumes:
      - ./src/test/resources/db.json:/data/db.json:ro
      - ./src/test/resources/static:/data/static:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  pgdata:
  sftp-data: