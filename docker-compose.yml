version: '3.9'

services:

  postgres:
    image: postgres:16-alpine
    container_name: postgres-jobrunr
    environment:
      POSTGRES_DB: jobrunr
      POSTGRES_USER: jobrunr
      POSTGRES_PASSWORD: jobrunr
    ports:
      - "5433:5432"           # avoid conflict with local Postgres
    volumes:
        - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U jobrunr"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  sftp-test:
    image: atmoz/sftp:latest
    container_name: sftp-test
    ports:
      - "2222:22"             # map to 2222 so it doesn't conflict with host SSH
    environment:
      - SFTP_USERS=testuser:testpass123:::upload
    volumes:
      - sftp-data:/home/testuser/upload
    restart: unless-stopped

  fake-source-api:
    image: node:20-alpine
    container_name: fake-source-api
    working_dir: /app
    command: >
      sh -c "npm install -g json-server &&
        json-server --watch /data/db.json --static /data/static --port 9090 --host 0.0.0.0"
    ports:
      - "9090:9090"
    volumes:
      - ./src/test/resources/db.json:/data/db.json:ro
      - ./src/test/resources/static:/data/static:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  pgdata:
  sftp-data: